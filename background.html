<html>
<head>
<script type="text/javascript" src="jquery-1.4.2.min.js"></script>
<script type="text/javascript" src="common.js"></script>
<script type="text/javascript">
var gTimer;
var globalContext = new Object();

$(document).ready(function() {
	setDefaults();
	globalContext.config = getAllPrefs();
	startTimer();
});

function restartTimer() {
	startTimer(); 
}

function startTimer() {
	if (gTimer) {
		clearInterval(gTimer);
	} else {
		fetchInfo();
	}
	gTimer = setInterval(fetchInfo, getPref('refresh_rate')*1000);
}

function addToSABnzbd(cb, request) {
	var nzburl = request.nzburl;
	var mode = request.mode;
	var nzbname = request.nzbname;
	
	var sabApiUrl = constructApiUrl();
	var data = constructApiPost(true);
	data.mode = mode;
	data.name = nzburl;
	data.output = 'json';
	if (request.nzbname) {
		data.nzbname = request.nzbname;
	}
	if (getPref('hardcoded_category') != '') {
		data.cat = getPref('hardcoded_category');
	} else if (request.category) {
		data.cat = request.category;
	} else if (getPref('default_category') != '') {
		data.cat = getPref('default_category');
	} 

	$.ajax({
		type: "GET",
		url: sabApiUrl,
		cache: false,
		username : getPref('http_user'),
		password : getPref('http_pass'),
		data: data,
		dataType: 'json',
		success: cb({'ret' : 'success', 'data' : data}),
		error: cb({'ret' : 'error'})
	});
	fetchInfo(true);
}

/**
* Handles data sent via chrome.extension.sendRequest().
* @param request Object Data sent in the request.
* @param sender Object Origin of the request.
* @param sendResponse Function The method to call when the request completes.
*/
function onRequest(request, sender, sendResponse) {
	switch(request.action) {
		case 'getContext':
			sendResponse({value: globalContext});
			return;
		case 'saveContext':
			globalContext = request.value;
			return;
		case 'reloadConfig':
			globalContext.config = getAllPrefs();
			break;
		case 'addToSABnzbd':
			addToSABnzbd(sendResponse, request);
			return;
		case 'refreshRateChanged':
			restartTimer();
			break;
	}
	sendResponse({});
	return;
};

// Wire up the listener.
chrome.extension.onRequest.addListener(onRequest);

</script>
</head>
<body></body>
</html>